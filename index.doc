<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trading Checklist & Risk Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0b1120;
      --bg-alt: #020617;
      --panel: #020617;
      --panel-alt: #111827;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.15);
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --success: #22c55e;
      --border: #1f2937;
      --radius-lg: 16px;
      --radius-md: 10px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
    }

    .app {
      max-width: 1300px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 18px;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #020617, #0f172a);
      border-radius: var(--radius-lg);
      border: 1px solid #1e293b;
      box-shadow: 0 18px 40px rgba(0,0,0,0.5);
    }

    header h1 {
      font-size: 1.1rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    header span.badge {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      color: var(--accent);
    }

    .layout {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 18px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: radial-gradient(circle at top left, #1f2937 0, #020617 55%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 14px 16px 16px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.8);
    }

    .card h2 {
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .section {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px dashed rgba(148, 163, 184, 0.2);
    }

    .flex {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="number"],
    textarea,
    select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 6px 10px;
      color: var(--text);
      font-size: 0.8rem;
      outline: none;
      width: 100%;
    }

    textarea {
      border-radius: 10px;
      min-height: 60px;
      resize: vertical;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    button {
      border-radius: 999px;
      padding: 6px 12px;
      border: none;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s;
    }

    button.primary {
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      color: #0b1120;
      font-weight: 600;
      box-shadow: 0 10px 25px rgba(34,197,94,0.4);
    }

    button.secondary {
      background: rgba(15,23,42,0.9);
      color: var(--text-muted);
      border: 1px solid #1f2937;
    }

    button.danger {
      background: rgba(127,29,29,0.8);
      color: #fecaca;
      border: 1px solid #7f1d1d;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(15,23,42,0.6);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .checklist-header {
      margin-bottom: 8px;
      gap: 6px;
    }

    .checklist-list {
      margin-top: 6px;
      max-height: 240px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .check-item {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      padding: 6px 8px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148,163,184,0.2);
      background: rgba(15,23,42,0.7);
      margin-bottom: 6px;
    }

    .check-item-main {
      flex: 1;
    }

    .check-item-title {
      font-size: 0.8rem;
      color: #e5e7eb;
    }

    .check-item-desc {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .check-item-meta {
      font-size: 0.7rem;
      color: rgba(148,163,184,0.8);
      margin-top: 2px;
    }

    .check-item-actions button {
      padding: 3px 6px;
      font-size: 0.7rem;
    }

    .checkbox {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid #4b5563;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      cursor: pointer;
      user-select: none;
    }

    .checkbox.checked {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
    }

    .score-pill {
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid #1f2937;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .score-percent {
      font-weight: 600;
      color: var(--accent);
    }

    .score-label {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .score-bar {
      margin-top: 6px;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      border: 1px solid #1f2937;
    }

    .score-bar-fill {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #ef4444, #facc15, #22c55e);
      transition: width 0.15s ease-out;
    }

    .two-col {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .field-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .field-row input {
      flex: 1;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .image-drop {
      border-radius: var(--radius-md);
      border: 1px dashed rgba(148,163,184,0.6);
      padding: 10px;
      text-align: center;
      font-size: 0.75rem;
      color: var(--text-muted);
      background: rgba(15,23,42,0.7);
      cursor: pointer;
    }

    .image-drop.dragover {
      border-color: var(--accent);
      background: rgba(56,189,248,0.08);
      color: var(--accent);
    }

    .image-preview {
      margin-top: 8px;
      max-height: 220px;
      overflow: auto;
      border-radius: var(--radius-md);
      border: 1px solid #1f2937;
      background: #020617;
      padding: 6px;
    }

    .image-preview img {
      max-width: 100%;
      border-radius: var(--radius-md);
    }

    .journal-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 0.75rem;
    }

    .journal-table th,
    .journal-table td {
      border-bottom: 1px solid rgba(31,41,55,0.9);
      padding: 4px 4px;
      text-align: left;
    }

    .journal-table th {
      color: var(--text-muted);
      font-weight: 500;
    }

    .journal-table td.small {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .tag {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(148,163,184,0.4);
    }

    .tag-long {
      color: #bbf7d0;
      border-color: #22c55e;
    }

    .tag-short {
      color: #fecaca;
      border-color: #f97373;
    }

    .link {
      color: var(--accent);
      text-decoration: underline dotted;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Trading Checklist & Risk Manager</h1>
        <div class="subtitle">Plan the trade · Log the setup · Manage the risk</div>
      </div>
      <span class="badge">Client-side · Free · No Login</span>
    </header>

    <div class="layout">
      <!-- LEFT SIDE: CHECKLIST + RISK -->
      <div class="card">
        <div class="flex-between checklist-header">
          <div>
            <h2>Trade Checklist</h2>
            <div class="subtitle">Define & confirm your rules before you click buy/sell.</div>
          </div>
          <div class="score-pill">
            <span class="score-percent" id="scorePercent">0%</span>
            <span class="score-label" id="scoreLabel">No rules checked yet</span>
          </div>
        </div>

        <div class="score-bar">
          <div class="score-bar-fill" id="scoreBarFill"></div>
        </div>

        <div class="section">
          <div class="two-col">
            <div class="field">
              <label for="symbol">Symbol / Pair</label>
              <input type="text" id="symbol" placeholder="e.g. EURUSD, ES, AAPL" />
            </div>
            <div class="field">
              <label for="direction">Direction</label>
              <select id="direction">
                <option value="">Select</option>
                <option value="long">Long</option>
                <option value="short">Short</option>
              </select>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="flex-between">
            <div class="pill">
              <span class="pill-dot"></span>
              <span>Checklist Rules</span>
            </div>
            <button class="secondary" id="addRuleBtn">+ Add Custom Rule</button>
          </div>

          <div class="checklist-list" id="checklistContainer">
            <!-- Rules will be injected here -->
          </div>
        </div>

        <div class="section">
          <div class="two-col">
            <div class="field">
              <label for="rsiInput">RSI (for auto-check example)</label>
              <input type="number" id="rsiInput" placeholder="e.g. 72" />
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button class="secondary" id="autoCheckBtn">Auto-check RSI Rule</button>
            </div>
          </div>
          <div class="subtitle">
            Auto-check demo: if RSI &gt; 70, the "RSI Overbought on HTF" rule is auto-marked as passed.
          </div>
        </div>

        <div class="section">
          <h2>Risk Calculator</h2>
          <div class="subtitle">Position sizing based on % risk and stop distance.</div>
          <div class="two-col">
            <div class="field">
              <label for="accountSize">Account Size ($)</label>
              <input type="number" id="accountSize" placeholder="e.g. 10000" />
            </div>
            <div class="field">
              <label for="riskPercent">Risk per Trade (%)</label>
              <input type="number" id="riskPercent" placeholder="e.g. 1" />
            </div>
          </div>

          <div class="two-col" style="margin-top: 8px;">
            <div class="field">
              <label for="entryPrice">Entry Price</label>
              <input type="number" id="entryPrice" placeholder="e.g. 4100.5" />
            </div>
            <div class="field">
              <label for="stopPrice">Stop Price</label>
              <input type="number" id="stopPrice" placeholder="e.g. 4085.0" />
            </div>
          </div>

          <div class="two-col" style="margin-top: 8px;">
            <div class="field">
              <label for="targetPrice">Target Price</label>
              <input type="number" id="targetPrice" placeholder="e.g. 4140.0" />
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button class="primary" id="calcRiskBtn">Calculate Risk & Size</button>
            </div>
          </div>

          <div class="section" id="riskResults" style="display:none; margin-top:8px;">
            <div class="two-col">
              <div class="field">
                <label>Risk Amount ($)</label>
                <div class="subtitle" id="riskAmountLabel">$0.00</div>
              </div>
              <div class="field">
                <label>Position Size (units)</label>
                <div class="subtitle" id="positionSizeLabel">0</div>
              </div>
            </div>
            <div class="two-col" style="margin-top: 4px;">
              <div class="field">
                <label>R:R Ratio</label>
                <div class="subtitle" id="rrLabel">0 : 0</div>
              </div>
              <div class="field">
                <label>Notes</label>
                <div class="subtitle" id="riskNoteLabel">–</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT SIDE: CHART + JOURNAL -->
      <div class="card">
        <h2>Chart & Journal</h2>
        <div class="subtitle">
          Attach charts, notes, and save a log of each planned trade.
        </div>

        <div class="section">
          <div class="field">
            <label>Chart Screenshot / Image</label>
            <div class="image-drop" id="imageDrop">
              <div><strong>Click to select</strong> or drag &amp; drop / paste an image (Ctrl+V).</div>
              <input type="file" id="imageInput" accept="image/*" style="display:none;" />
            </div>
            <div class="subtitle">
              Tip: take a screenshot of your TradingView chart and paste it here.
            </div>
          </div>
          <div class="image-preview" id="imagePreview" style="display:none;">
            <img id="previewImg" src="" alt="Chart preview" />
          </div>
        </div>

        <div class="section">
          <div class="field">
            <label for="tradeNotes">Trade Notes / Narrative</label>
            <textarea id="tradeNotes" placeholder="Why this setup? HTF context, liquidity, news, etc."></textarea>
          </div>
        </div>

        <div class="section">
          <div class="flex-between">
            <button class="secondary danger" id="clearJournalBtn">Clear Journal (local)</button>
            <button class="primary" id="saveTradeBtn">Save Trade to Journal</button>
          </div>

          <div class="section">
            <div class="flex-between">
              <div class="pill">
                <span class="pill-dot"></span>
                <span>Trade Journal (saved in this browser)</span>
              </div>
              <div class="subtitle" id="journalCountLabel">0 trades</div>
            </div>
            <table class="journal-table" id="journalTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Symbol</th>
                  <th>Side</th>
                  <th>Score</th>
                  <th>R:R</th>
                  <th>Chart</th>
                </tr>
              </thead>
              <tbody id="journalBody">
                <!-- Entries injected here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ------- INITIAL CHECKLIST RULES (you can tweak these labels) ------
    const defaultRules = [
      {
        id: "rule-1",
        label: "Price at a 1H supply or demand zone",
        desc: "Marked zone on the 1H timeframe; current price is inside or tapping it.",
        checked: false
      },
      {
        id: "rule-2",
        label: "1H trendline break in trade direction",
        desc: "Trendline break aligns with intended long/short bias.",
        checked: false
      },
      {
        id: "rule-3",
        label: "RSI overbought/oversold confluence (1H / 30m / 15m)",
        desc: "RSI on higher timeframes supports the direction of the idea.",
        checked: false,
        auto: true // we'll use this for auto-check demo
      },
      {
        id: "rule-4",
        label: "Price left 1H zone multiple times on LTF",
        desc: "Driving away from zone showed real intent (no weak reaction).",
        checked: false
      },
      {
        id: "rule-5",
        label: "Structure break + lower low / higher high on 5m",
        desc: "Clear BOS + continuation in your intended direction.",
        checked: false
      },
      {
        id: "rule-6",
        label: "Clean retrace back to breakout level",
        desc: "No heavy chop on the retest, level respected.",
        checked: false
      },
      {
        id: "rule-7",
        label: "Risk, news, and session context OK",
        desc: "No high-impact news against you, session fits your system.",
        checked: false
      }
    ];

    const checklistContainer = document.getElementById("checklistContainer");
    const scorePercentEl = document.getElementById("scorePercent");
    const scoreLabelEl = document.getElementById("scoreLabel");
    const scoreBarFillEl = document.getElementById("scoreBarFill");
    const addRuleBtn = document.getElementById("addRuleBtn");
    const autoCheckBtn = document.getElementById("autoCheckBtn");
    const rsiInput = document.getElementById("rsiInput");

    const riskResults = document.getElementById("riskResults");
    const riskAmountLabel = document.getElementById("riskAmountLabel");
    const positionSizeLabel = document.getElementById("positionSizeLabel");
    const rrLabel = document.getElementById("rrLabel");
    const riskNoteLabel = document.getElementById("riskNoteLabel");
    const calcRiskBtn = document.getElementById("calcRiskBtn");

    const accountSizeInput = document.getElementById("accountSize");
    const riskPercentInput = document.getElementById("riskPercent");
    const entryPriceInput = document.getElementById("entryPrice");
    const stopPriceInput = document.getElementById("stopPrice");
    const targetPriceInput = document.getElementById("targetPrice");

    const imageDrop = document.getElementById("imageDrop");
    const imageInput = document.getElementById("imageInput");
    const imagePreview = document.getElementById("imagePreview");
    const previewImg = document.getElementById("previewImg");

    const symbolInput = document.getElementById("symbol");
    const directionInput = document.getElementById("direction");
    const tradeNotesInput = document.getElementById("tradeNotes");
    const saveTradeBtn = document.getElementById("saveTradeBtn");
    const clearJournalBtn = document.getElementById("clearJournalBtn");
    const journalBody = document.getElementById("journalBody");
    const journalCountLabel = document.getElementById("journalCountLabel");

    let rules = [...defaultRules];
    let chartDataUrl = null;
    let journal = [];

    // ---- CHECKLIST RENDERING ----
    function renderChecklist() {
      checklistContainer.innerHTML = "";

      rules.forEach((rule, index) => {
        const item = document.createElement("div");
        item.className = "check-item";

        const check = document.createElement("div");
        check.className = "checkbox" + (rule.checked ? " checked" : "");
        check.textContent = rule.checked ? "✓" : "";
        check.addEventListener("click", () => {
          rule.checked = !rule.checked;
          updateScore();
          renderChecklist();
        });

        const main = document.createElement("div");
        main.className = "check-item-main";

        const title = document.createElement("div");
        title.className = "check-item-title";
        title.textContent = rule.label;

        const desc = document.createElement("div");
        desc.className = "check-item-desc";
        desc.textContent = rule.desc || "";

        const meta = document.createElement("div");
        meta.className = "check-item-meta";
        meta.textContent = rule.auto ? "Auto-check capable (RSI example)" : "Manual rule";

        main.appendChild(title);
        main.appendChild(desc);
        main.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "check-item-actions";
        const editBtn = document.createElement("button");
        editBtn.className = "secondary";
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => editRule(rule, index));

        const delBtn = document.createElement("button");
        delBtn.className = "danger";
        delBtn.textContent = "X";
        delBtn.addEventListener("click", () => {
          if (confirm("Delete this rule?")) {
            rules.splice(index, 1);
            updateScore();
            renderChecklist();
          }
        });

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        item.appendChild(check);
        item.appendChild(main);
        item.appendChild(actions);

        checklistContainer.appendChild(item);
      });

      updateScore();
    }

    function editRule(rule, index) {
      const newLabel = prompt("Edit rule label:", rule.label);
      if (newLabel === null) return;
      const newDesc = prompt("Edit rule description:", rule.desc || "");
      if (newDesc === null) return;

      rules[index].label = newLabel.trim() || rules[index].label;
      rules[index].desc = newDesc.trim();
      renderChecklist();
    }

    addRuleBtn.addEventListener("click", () => {
      const label = prompt("Enter rule label:");
      if (!label) return;
      const desc = prompt("Enter rule description (optional):") || "";
      rules.push({
        id: "rule-" + (Date.now()),
        label: label.trim(),
        desc: desc.trim(),
        checked: false
      });
      renderChecklist();
    });

    function updateScore() {
      const total = rules.length || 1;
      const passed = rules.filter(r => r.checked).length;
      const pct = Math.round((passed / total) * 100);

      scorePercentEl.textContent = pct + "%";
      scoreBarFillEl.style.width = pct + "%";

      if (pct === 0) {
        scoreLabelEl.textContent = "No rules checked yet";
      } else if (pct < 40) {
        scoreLabelEl.textContent = "Weak setup · be cautious";
      } else if (pct < 70) {
        scoreLabelEl.textContent = "Decent · but could be better";
      } else if (pct < 100) {
        scoreLabelEl.textContent = "Strong setup · almost full confluence";
      } else {
        scoreLabelEl.textContent = "ALL rules satisfied · A+ setup";
      }
    }

    // ---- AUTO-CHECK EXAMPLE (RSI) ----
    autoCheckBtn.addEventListener("click", () => {
      const rsi = parseFloat(rsiInput.value);
      if (isNaN(rsi)) {
        alert("Enter an RSI value first.");
        return;
      }
      const rule = rules.find(r => r.auto);
      if (!rule) {
        alert("No auto-check RSI rule defined.");
        return;
      }
      // example logic: RSI > 70 => overbought confluence
      if (rsi > 70) {
        rule.checked = true;
        alert("RSI is high (" + rsi + "). Marking RSI confluence rule as PASSED.");
      } else {
        rule.checked = false;
        alert("RSI is not high (" + rsi + "). Marking RSI confluence rule as NOT passed.");
      }
      renderChecklist();
    });

    // ---- RISK CALCULATOR ----
    calcRiskBtn.addEventListener("click", () => {
      const account = parseFloat(accountSizeInput.value);
      const riskPct = parseFloat(riskPercentInput.value);
      const entry = parseFloat(entryPriceInput.value);
      const stop = parseFloat(stopPriceInput.value);
      const target = parseFloat(targetPriceInput.value);

      if ([account, riskPct, entry, stop, target].some(v => isNaN(v))) {
        alert("Please fill in account size, risk %, entry, stop, and target.");
        return;
      }

      const riskAmount = account * (riskPct / 100);
      const stopDistance = Math.abs(entry - stop);
      const rewardDistance = Math.abs(target - entry);
      const rr = stopDistance === 0 ? 0 : rewardDistance / stopDistance;
      const positionSize = stopDistance === 0 ? 0 : riskAmount / stopDistance;

      riskResults.style.display = "block";
      riskAmountLabel.textContent = `$${riskAmount.toFixed(2)}`;
      positionSizeLabel.textContent = positionSize.toFixed(4);
      rrLabel.textContent = rr.toFixed(2) + " : 1";

      let note = "";
      if (rr >= 2) note = "Nice R:R. Consider partials & trailing.";
      else if (rr >= 1) note = "Acceptable R:R. Make sure confluence is strong.";
      else note = "R:R < 1. Be extremely cautious taking this.";

      riskNoteLabel.textContent = note;
    });

    // ---- IMAGE UPLOAD / PASTE ----
    function handleFiles(files) {
      if (!files || !files.length) return;
      const file = files[0];
      if (!file.type.startsWith("image/")) {
        alert("Please upload an image file.");
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        chartDataUrl = e.target.result;
        previewImg.src = chartDataUrl;
        imagePreview.style.display = "block";
      };
      reader.readAsDataURL(file);
    }

    imageDrop.addEventListener("click", () => imageInput.click());
    imageInput.addEventListener("change", e => handleFiles(e.target.files));

    imageDrop.addEventListener("dragover", e => {
      e.preventDefault();
      imageDrop.classList.add("dragover");
    });
    imageDrop.addEventListener("dragleave", e => {
      e.preventDefault();
      imageDrop.classList.remove("dragover");
    });
    imageDrop.addEventListener("drop", e => {
      e.preventDefault();
      imageDrop.classList.remove("dragover");
      handleFiles(e.dataTransfer.files);
    });

    // paste from clipboard
    window.addEventListener("paste", e => {
      if (e.clipboardData && e.clipboardData.files.length > 0) {
        handleFiles(e.clipboardData.files);
      }
    });

    // ---- JOURNAL STORAGE ----
    const STORAGE_KEY = "trading-checklist-journal-v1";

    function loadJournal() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        journal = data ? JSON.parse(data) : [];
      } catch (err) {
        console.error("Failed to load journal", err);
        journal = [];
      }
      renderJournal();
    }

    function saveJournal() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(journal));
      } catch (err) {
        console.error("Failed to save journal", err);
      }
    }

    function renderJournal() {
      journalBody.innerHTML = "";
      journal.forEach(entry => {
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.className = "small";
        tdDate.textContent = entry.date;

        const tdSym = document.createElement("td");
        tdSym.textContent = entry.symbol || "-";

        const tdSide = document.createElement("td");
        const tag = document.createElement("span");
        tag.className = "tag " + (entry.direction === "long" ? "tag-long" : "tag-short");
        tag.textContent = entry.direction || "-";
        tdSide.appendChild(tag);

        const tdScore = document.createElement("td");
        tdScore.className = "small";
        tdScore.textContent = entry.score + "%";

        const tdRR = document.createElement("td");
        tdRR.className = "small";
        tdRR.textContent = entry.rrLabel || "-";

        const tdChart = document.createElement("td");
        tdChart.className = "small";
        if (entry.hasChart) {
          const link = document.createElement("span");
          link.className = "link";
          link.textContent = "View";
          link.addEventListener("click", () => {
            if (entry.chartDataUrl) {
              previewImg.src = entry.chartDataUrl;
              imagePreview.style.display = "block";
              chartDataUrl = entry.chartDataUrl;
              window.scrollTo({ top: 0, behavior: "smooth" });
            } else {
              alert("Chart image was not preserved (storage-limited).");
            }
          });
          tdChart.appendChild(link);
        } else {
          tdChart.textContent = "–";
        }

        tr.appendChild(tdDate);
        tr.appendChild(tdSym);
        tr.appendChild(tdSide);
        tr.appendChild(tdScore);
        tr.appendChild(tdRR);
        tr.appendChild(tdChart);

        journalBody.appendChild(tr);
      });

      journalCountLabel.textContent = `${journal.length} trade${journal.length === 1 ? "" : "s"}`;
    }

    saveTradeBtn.addEventListener("click", () => {
      const symbol = symbolInput.value.trim();
      const direction = directionInput.value;
      const notes = tradeNotesInput.value.trim();

      // compute score
      const total = rules.length || 1;
      const passed = rules.filter(r => r.checked).length;
      const score = Math.round((passed / total) * 100);

      const rrText = rrLabel.textContent || "";

      if (!symbol) {
        if (!confirm("No symbol entered. Save anyway?")) return;
      }

      const now = new Date();
      const entry = {
        date: now.toLocaleString(),
        symbol,
        direction,
        score,
        rrLabel: rrText,
        notes,
        hasChart: !!chartDataUrl,
        chartDataUrl // note: could be large if many entries
      };

      journal.unshift(entry);
      saveJournal();
      renderJournal();
      alert("Trade saved to journal.");
    });

    clearJournalBtn.addEventListener("click", () => {
      if (!confirm("This will clear all saved trades from this browser. Continue?")) return;
      journal = [];
      saveJournal();
      renderJournal();
    });

    // ---- INIT ----
    renderChecklist();
    loadJournal();
  </script>
</body>
</html>
